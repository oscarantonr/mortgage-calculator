<div class="mortgage-calculator">
  <div class="calculator-layout">
    <!-- Columna izquierda: formulario -->
    <div class="calculator-card">
      <h2>Calculadora de hipoteca</h2>
      <form [formGroup]="mortgageForm" (ngSubmit)="calculateMortgage()">
        <div class="form-group">
          <label for="loanAmount">Importe del pr√©stamo</label>
          <div class="input-group">
            <input 
              type="text" 
              id="loanAmount" 
              formControlName="loanAmount" 
              class="form-control" 
              placeholder="Ej: 150000,5">
            <span class="input-addon">‚Ç¨</span>
          </div>
          <div class="form-error" *ngIf="mortgageForm.get('loanAmount')?.invalid && mortgageForm.get('loanAmount')?.touched">
            El importe del pr√©stamo es obligatorio y debe ser mayor que 0
          </div>
        </div>

        <div class="form-group">
          <label for="earlyRepayment">Amortizaci√≥n anticipada (opcional)</label>
          <div class="input-group">
            <input 
              type="text" 
              id="earlyRepayment" 
              formControlName="earlyRepayment" 
              class="form-control" 
              placeholder="Ej: 10.000"
              appEuropeanNumberInput>
            <span class="input-addon">‚Ç¨</span>
          </div>
          <div class="form-hint">
            Cantidad que deseas amortizar anticipadamente
          </div>
        </div>

        <div class="form-group">
          <label>Tipo de inter√©s</label>
          <div class="radio-group">
            <div *ngFor="let type of interestTypes" class="radio-option">
              <input type="radio" [id]="type.value" [value]="type.value" formControlName="interestType">
              <label [for]="type.value">{{ type.label }}</label>
            </div>
          </div>
        </div>

        <div class="form-group" *ngIf="mortgageForm.get('interestType')?.value === 'fixed'">
          <label for="interestRate">Inter√©s fijo (%)</label>
          <div class="input-group">
            <input 
              type="text" 
              id="interestRate" 
              formControlName="interestRate" 
              class="form-control" 
              placeholder="Ej: 3,5"
              >
            <span class="input-addon">%</span>
          </div>
        </div>

        <div *ngIf="mortgageForm.get('interestType')?.value === 'variable'">
          <div class="form-group">
            <label>Eur√≠bor actual</label>
            <div class="input-group">
              <input type="text" [value]="currentEuribor | europeanNumber" class="form-control" disabled>
              <span class="input-addon">%</span>
            </div>
          </div>

          <div class="form-group">
            <label for="differential">Diferencial (%)</label>
            <div class="input-group">
              <input 
                type="text" 
                id="differential" 
                formControlName="differential" 
                class="form-control" 
                placeholder="Ej: 1,0"
                appEuropeanNumberInput>
              <span class="input-addon">%</span>
            </div>
          </div>

          <div class="form-group">
            <label for="interestRate">Inter√©s resultante</label>
            <div class="input-group">
              <input type="text" id="interestRate" formControlName="interestRate" class="form-control" readonly>
              <span class="input-addon">%</span>
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="term">Plazo</label>
          <div class="term-inputs-row">
            <div class="col-6">
              <div class="input-group term-input">
                <!-- Input que cambia seg√∫n el tipo seleccionado -->
                <input 
                  *ngIf="mortgageForm.get('termType')?.value !== 'endDate'"
                  type="text" 
                  id="term" 
                  formControlName="term" 
                  class="form-control"
                  [placeholder]="mortgageForm.get('termType')?.value === 'years' ? 'Ej: 30' : 'Ej: 360'"
                  appEuropeanNumberInput>
                
                <!-- Input de fecha con formato personalizado -->
                <div *ngIf="mortgageForm.get('termType')?.value === 'endDate'" class="date-input-container">
                  <input 
                    type="text" 
                    id="endDateDisplay" 
                    class="form-control date-display"
                    [value]="displayDate"
                    placeholder="dd/mm/yyyy"
                    (input)="onManualDateInput($event)"
                    (blur)="onDateBlur($event)">
                  <input 
                    type="date" 
                    formControlName="endDate" 
                    class="date-input-hidden"
                    (change)="onDatePickerChange($event)">
                  <button 
                    type="button" 
                    class="date-picker-btn"
                    (click)="openDatePicker()"
                    title="Seleccionar fecha">
                    üìÖ
                  </button>
                </div>
                
                <!-- Addon que cambia seg√∫n el tipo -->
                <span class="input-addon" *ngIf="mortgageForm.get('termType')?.value === 'years'">a√±os</span>
                <span class="input-addon" *ngIf="mortgageForm.get('termType')?.value === 'months'">meses</span>
              </div>
            </div>
            
            <div class="col-6">
              <!-- Radio buttons con nueva opci√≥n -->
              <div class="radio-group term-type">
                <div class="radio-option">
                  <input type="radio" id="term-years" value="years" formControlName="termType">
                  <label for="term-years">A√±os</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="term-months" value="months" formControlName="termType">
                  <label for="term-months">Meses</label>
                </div>
                <div class="radio-option">
                  <input type="radio" id="term-endDate" value="endDate" formControlName="termType">
                  <label for="term-endDate">Fecha fin</label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Texto de ayuda que cambia seg√∫n la selecci√≥n -->
          <div class="form-hint">
            <span *ngIf="mortgageForm.get('termType')?.value === 'years'">
              Plazo en a√±os completos
            </span>
            <span *ngIf="mortgageForm.get('termType')?.value === 'months'">
              Plazo en meses
            </span>
            <span *ngIf="mortgageForm.get('termType')?.value === 'endDate' && mortgageForm.get('endDate')?.value">
              Plazo calculado: {{ getCalculatedTermFromDate() }}
            </span>
            <span *ngIf="mortgageForm.get('termType')?.value === 'endDate' && !mortgageForm.get('endDate')?.value">
              Selecciona la fecha de finalizaci√≥n de tu hipoteca
            </span>
          </div>
          
          <div class="form-error" *ngIf="mortgageForm.get('term')?.invalid && mortgageForm.get('term')?.touched">
            <span *ngIf="mortgageForm.get('termType')?.value === 'years'">El plazo debe estar entre 1 y 40 a√±os</span>
            <span *ngIf="mortgageForm.get('termType')?.value === 'months'">El plazo debe estar entre 1 y 480 meses</span>
          </div>
        </div>

        <div class="form-group buttons">
          <button type="submit" class="btn-primary" [disabled]="mortgageForm.invalid">Calcular hipoteca</button>
          <button type="button" class="btn-secondary" (click)="resetCalculator()">Reiniciar</button>
        </div>
      </form>
    </div>

    <!-- Columna derecha: resumen de resultados -->
    <div class="results-summary-container" *ngIf="showResults">
      <div class="results-card summary-card">
        <h2 *ngIf="!showEarlyRepaymentResults">Resumen</h2>
        <h2 *ngIf="showEarlyRepaymentResults">Opciones de amortizaci√≥n</h2>
        
        <div class="result-summary" *ngIf="!showEarlyRepaymentResults">
          <div class="result-item">
            <h3>Cuota mensual</h3>
            <p class="result-value">{{ monthlyPayment | europeanNumber }} ‚Ç¨</p>
          </div>
          
          <div class="result-item">
            <h3>Intereses totales</h3>
            <p class="result-value">{{ totalInterest | europeanNumber }} ‚Ç¨</p>
          </div>
          
          <div class="result-item">
            <h3>Importe total</h3>
            <p class="result-value">{{ totalAmount | europeanNumber }} ‚Ç¨</p>
          </div>
          
          <div class="result-item">
            <h3>Plazo total</h3>
            <p class="result-value">
              <span *ngIf="mortgageForm.get('termType')?.value === 'years'">
                {{ formatLoanTerm(+mortgageForm.get('term')?.value * 12) }}
                ({{ mortgageForm.get('term')?.value * 12 }} meses)
              </span>
              <span *ngIf="mortgageForm.get('termType')?.value === 'months'">
                {{ formatLoanTerm(+mortgageForm.get('term')?.value) }}
                ({{ mortgageForm.get('term')?.value }} meses)
              </span>
              <span *ngIf="mortgageForm.get('termType')?.value === 'endDate' && mortgageForm.get('endDate')?.value">
                {{ getCalculatedTermFromDate() }}
                ({{ getCalculatedMonthsFromDate() }} meses)
              </span>
              <span *ngIf="mortgageForm.get('termType')?.value === 'endDate' && !mortgageForm.get('endDate')?.value" class="text-muted">
                Seleccione una fecha de finalizaci√≥n
              </span>
            </p>
          </div>
        </div>
        
        <!-- Resultados de amortizaci√≥n anticipada -->
        <div class="early-repayment-results" *ngIf="showEarlyRepaymentResults">
          
          <!-- Opci√≥n 1: Reducir plazo -->
          <div class="amortization-option">
            <div class="option-header">
              <h4>Reduciendo plazo ahorras:</h4>
            </div>
            <div class="savings-display">
              <div class="savings-amount">{{ earlyRepaymentResults.reducingTerm.savings | europeanNumber }} ‚Ç¨</div>
              <div class="savings-percentage-line">{{ earlyRepaymentResults.reducingTerm.savingsPercentage | europeanNumber }}% del total de intereses</div>
            </div>
            
            <div class="option-details">
              <div class="detail-item">
                <span class="detail-label">Cuota:</span>
                <span class="detail-value">{{ earlyRepaymentResults.reducingTerm.monthlyPayment | europeanNumber }} ‚Ç¨ <small>(se mantiene)</small></span>
              </div>
              
              <div class="detail-item">
                <span class="detail-label">Plazo actual:</span>
                <span class="detail-value">
                  {{ formatLoanTerm(earlyRepaymentResults.reducingTerm.originalTerm.years * 12 + earlyRepaymentResults.reducingTerm.originalTerm.months) }}
                </span>
              </div>
              
              <div class="detail-item">
                <span class="detail-label">Reducci√≥n del plazo:</span>
                <span class="detail-value highlight">
                  {{ formatLoanTerm(earlyRepaymentResults.reducingTerm.termReduction.years * 12 + earlyRepaymentResults.reducingTerm.termReduction.months) }}
                </span>
              </div>
              
              <div class="detail-item">
                <span class="detail-label">Nuevo plazo:</span>
                <span class="detail-value">
                  {{ formatLoanTerm(earlyRepaymentResults.reducingTerm.newTerm.years * 12 + earlyRepaymentResults.reducingTerm.newTerm.months) }}
                </span>
              </div>
            </div>
          </div>
          
          <!-- Opci√≥n 2: Reducir cuota -->
          <div class="amortization-option">
            <div class="option-header">
              <h4>Reduciendo cuota ahorras:</h4>
            </div>
            <div class="savings-display">
              <div class="savings-amount">{{ earlyRepaymentResults.reducingPayment.savings | europeanNumber }} ‚Ç¨</div>
              <div class="savings-percentage-line">{{ earlyRepaymentResults.reducingPayment.savingsPercentage | europeanNumber }}% del total de intereses</div>
            </div>
            
            <div class="option-details">
              <div class="detail-item">
                <span class="detail-label">Plazo:</span>
                <span class="detail-value">
                  {{ formatLoanTerm(earlyRepaymentResults.reducingPayment.term.years * 12 + earlyRepaymentResults.reducingPayment.term.months) }}
                  <small>(se mantiene)</small>
                </span>
              </div>
              
              <div class="detail-item">
                <span class="detail-label">Cuota actual:</span>
                <span class="detail-value">{{ earlyRepaymentResults.reducingPayment.originalPayment | europeanNumber }} ‚Ç¨</span>
              </div>
              
              <div class="detail-item">
                <span class="detail-label">Reducci√≥n de cuota:</span>
                <span class="detail-value highlight">{{ earlyRepaymentResults.reducingPayment.paymentReduction | europeanNumber }} ‚Ç¨</span>
              </div>
              
              <div class="detail-item">
                <span class="detail-label">Nueva cuota:</span>
                <span class="detail-value">{{ earlyRepaymentResults.reducingPayment.newPayment | europeanNumber }} ‚Ç¨</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla de amortizaci√≥n abajo (siempre a ancho completo) -->
  <div class="amortization-table-container" *ngIf="showResults">
    <div class="results-card">
      <h3>Tabla de amortizaci√≥n (primer a√±o)</h3>
      <div class="amortization-table">
        <table>
          <thead>
            <tr>
              <th>Mes</th>
              <th>Cuota</th>
              <th>Amortizaci√≥n</th>
              <th>Intereses</th>
              <th>Capital pendiente</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of amortizationSchedule">
              <td>{{ row.month }}</td>
              <td>{{ row.payment | europeanNumber }} ‚Ç¨</td>
              <td>{{ row.principalPayment | europeanNumber }} ‚Ç¨</td>
              <td>{{ row.interest | europeanNumber }} ‚Ç¨</td>
              <td>{{ row.balance | europeanNumber }} ‚Ç¨</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Gr√°ficos de an√°lisis visual -->
  <app-mortgage-chart 
    *ngIf="showResults && chartData.length > 0"
    [amortizationData]="chartData"
    [earlyRepaymentData]="earlyRepaymentChartData"
    [monthlyPayment]="monthlyPayment">
  </app-mortgage-chart>
</div>